name: Static Linux Build

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-static-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust toolchain with musl target
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-unknown-linux-musl
        
    - name: Install musl tools and lld linker
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools lld clang
        
    - name: Create syscall stubs for missing musl functions
      run: |
        # Create stubs for preadv2 and pwritev2 which are not in musl
        # These are newer Linux syscalls that Python uses but musl doesn't provide wrappers for
        mkdir -p syscall-stubs
        cat > syscall-stubs/syscall_stubs.c << 'EOF'
        #define _GNU_SOURCE
        #include <sys/uio.h>
        #include <sys/syscall.h>
        #include <unistd.h>
        
        // Stub for preadv2 - fallback to preadv if not available
        ssize_t preadv2(int fd, const struct iovec *iov, int iovcnt, off_t offset, int flags) {
            // If flags is 0, we can use preadv
            if (flags == 0) {
                return preadv(fd, iov, iovcnt, offset);
            }
            // Otherwise, try the syscall directly
        #ifdef SYS_preadv2
            return syscall(SYS_preadv2, fd, iov, iovcnt, offset, flags);
        #else
            // Fallback if syscall not available
            return preadv(fd, iov, iovcnt, offset);
        #endif
        }
        
        // Stub for pwritev2 - fallback to pwritev if not available
        ssize_t pwritev2(int fd, const struct iovec *iov, int iovcnt, off_t offset, int flags) {
            // If flags is 0, we can use pwritev
            if (flags == 0) {
                return pwritev(fd, iov, iovcnt, offset);
            }
            // Otherwise, try the syscall directly
        #ifdef SYS_pwritev2
            return syscall(SYS_pwritev2, fd, iov, iovcnt, offset, flags);
        #else
            // Fallback if syscall not available
            return pwritev(fd, iov, iovcnt, offset);
        #endif
        }
        EOF
        
        # Compile the stubs into a static library
        musl-gcc -c syscall-stubs/syscall_stubs.c -o syscall-stubs/syscall_stubs.o
        ar rcs syscall-stubs/libsyscall_stubs.a syscall-stubs/syscall_stubs.o
        
        echo "Created syscall stubs library"
        ls -l syscall-stubs/
        
    - name: Download and extract static Python build
      run: |
        # Download the static Python build from python-build-standalone
        wget https://github.com/astral-sh/python-build-standalone/releases/download/20251028/cpython-3.13.9+20251028-x86_64_v2-unknown-linux-musl-lto+static-full.tar.zst
        
        # Install zstd to extract the archive
        sudo apt-get install -y zstd
        
        # Extract the archive
        tar -xf cpython-3.13.9+20251028-x86_64_v2-unknown-linux-musl-lto+static-full.tar.zst
        
        # Set up environment variables for the static Python installation
        echo "PYTHON_ROOT=$(pwd)/python/install" >> $GITHUB_ENV
        echo "PYO3_PYTHON=$(pwd)/python/install/bin/python3.13" >> $GITHUB_ENV
        echo "PYO3_CONFIG_FILE=$(pwd)/pyo3-config.txt" >> $GITHUB_ENV
        
    - name: Create pyo3 override for static build
      run: |
        # For static musl builds with embedded Python, we need pyo3 without abi3
        # Create a temporary patch in Cargo.toml that uses a local path override
        # This is cleaner than sed and doesn't modify the committed files
        
        # Create a local pyo3-no-abi3 directory with a Cargo.toml that re-exports pyo3
        mkdir -p pyo3-override
        cat > pyo3-override/Cargo.toml << 'EOF'
        [package]
        name = "pyo3-override"
        version = "0.26.0"
        edition = "2021"
        
        [dependencies]
        pyo3 = { version = "0.26.0", features = ["macros"], default-features = false }
        
        [lib]
        path = "lib.rs"
        EOF
        
        cat > pyo3-override/lib.rs << 'EOF'
        pub use pyo3::*;
        EOF
        
        # Add path override to Cargo.toml (this won't be committed)
        echo '' >> Cargo.toml
        echo '[patch.crates-io]' >> Cargo.toml
        echo 'pyo3 = { path = "pyo3-override" }' >> Cargo.toml
        
        echo "Added pyo3 override to use non-abi3 version"
        
    - name: Configure pyo3 for static linking
      run: |
        # Create pyo3 config file for static linking
        cat > pyo3-config.txt << EOF
        implementation=CPython
        version=3.13
        shared=false
        abi3=false
        lib_name=python3.13
        lib_dir=$PYTHON_ROOT/lib
        executable=$PYTHON_ROOT/bin/python3.13
        pointer_width=64
        build_flags=
        suppress_build_script_link_lines=false
        EOF
        
        cat pyo3-config.txt
        
    - name: Build static binary
      run: |
        # Build with static linking to musl and Python static libraries
        # The Python static build includes many extension modules that need additional libraries
        # Note: We use lld linker as it can handle LLVM bitcode from the Python LTO build
        
        # Set up library paths for Python static libraries and syscall stubs
        export PYTHON_LIB_DIR="$(pwd)/python/build/lib"
        export STUB_LIB_DIR="$(pwd)/syscall-stubs"
        
        # Configure RUSTFLAGS for static linking with musl
        export RUSTFLAGS="-C target-feature=+crt-static -C linker=clang -C link-arg=-fuse-ld=lld -C link-arg=--target=x86_64-unknown-linux-musl -L ${PYTHON_LIB_DIR} -L ${STUB_LIB_DIR}"
        
        # Add syscall stubs first
        export RUSTFLAGS="$RUSTFLAGS -C link-arg=-lsyscall_stubs"
        
        # Add all required Python extension libraries
        # Order matters - dependencies must come after libraries that need them
        LINK_LIBS="-ltk8.6 -ltcl8.6 -lX11 -lxcb -lXau -ledit -lncursesw -lpanelw -lformw -lmenuw -lexpat -lffi -lzstd -lsqlite3 -lmpdec -lbz2 -llzma -lssl -lcrypto -lz -luuid -ldb"
        
        for lib in $LINK_LIBS; do
          export RUSTFLAGS="$RUSTFLAGS -C link-arg=$lib"
        done
        
        export PKG_CONFIG_ALLOW_CROSS=1
        export PKG_CONFIG_ALL_STATIC=1
        
        echo "RUSTFLAGS: $RUSTFLAGS"
        echo "Building static binary..."
        
        # Build the static binary
        # Disable default features to exclude mimalloc (conflicts with Python's allocator)
        # Re-enable needed features except mimalloc
        cargo build --release --target x86_64-unknown-linux-musl --no-default-features --features bed,csi,core,bam,sam,bgzf 2>&1 | tee build.log
        
        # Check if build succeeded
        if [ ! -f target/x86_64-unknown-linux-musl/release/bedder ]; then
          echo "Build failed! Last 100 lines of output:"
          tail -100 build.log
          exit 1
        fi
        
    - name: Verify static binary
      run: |
        # Check that the binary is statically linked
        echo "Binary info:"
        ls -lh target/x86_64-unknown-linux-musl/release/bedder
        
        echo -e "\nChecking dynamic dependencies (should show 'not a dynamic executable'):"
        ldd target/x86_64-unknown-linux-musl/release/bedder || echo "âœ“ Completely static binary (no dynamic dependencies)"
        
        echo -e "\nFile type:"
        file target/x86_64-unknown-linux-musl/release/bedder
        
    - name: Test binary
      run: |
        target/x86_64-unknown-linux-musl/release/bedder --help
        
    - name: Upload static binary
      uses: actions/upload-artifact@v4
      with:
        name: bedder-static-musl-linux-x86_64
        path: target/x86_64-unknown-linux-musl/release/bedder
