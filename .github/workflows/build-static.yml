name: Build Static GNU Binary

on:
  push:
    branches: [main, master, dev, build]
  pull_request:
  workflow_dispatch:

jobs:
  linux-gnu:
    name: Build bedder (${{ matrix.target }})
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            python_url: https://github.com/astral-sh/python-build-standalone/releases/download/20251028/cpython-3.13.9%2B20251028-x86_64-unknown-linux-gnu-pgo%2Blto-full.tar.zst
    env:
      TARGET_TRIPLE: ${{ matrix.target }}
      WORKDIR_PATH: ${{ github.workspace }}
      PYTHON_URL: ${{ matrix.python_url }}
      PYTHON_ARCHIVE: ${{ github.workspace }}/python-archive.tar.zst
      PYTHON_GNU_DIR: ${{ github.workspace }}/third_party/python-gnu/python
      PYTHON_ROOT_OVERRIDE: ${{ github.workspace }}/third_party/python-gnu/python
      PYO3_CONFIG_FILE: ${{ github.workspace }}/pyo3-config.txt
      OPENSSL_NO_VENDOR: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Diagnostic step: Capture apt/dpkg state for debugging package conflicts
      # This helps identify held packages or conflicting python-clang versions
      - name: Diagnose apt/dpkg state
        run: |
          sudo apt-get update
          echo "=== apt holds ==="
          apt-mark showhold || true
          echo "=== dpkg selections with hold ==="
          dpkg --get-selections | grep hold || true
          echo "=== python-clang packages policy ==="
          apt-cache policy python3-clang-18 python3-clang-19 python3-clang-20 python-clang-x.y || true
          echo "=== available clang libs ==="
          apt-cache search ^libclang || true

      # Repair apt, remove conflicting python-clang packages, and update
      # Debian python-clang packages often conflict across minor versions and can be held on runners.
      # This step clears broken package states and removes conflicting packages before installation.
      - name: Repair apt, remove conflicting python-clang packages, and update
        run: |
          sudo dpkg --configure -a || true
          sudo apt-get install -y -f || true
          sudo apt-get remove -y --purge python-clang-x.y python-clang-18 python-clang-19 python-clang-20 || true
          sudo apt-mark unhold python-clang-x.y python-clang-18 python-clang-19 python-clang-20 || true
          sudo apt-get update

      # Install libclang and python clang bindings via pip
      # Using libclang-dev + pip-installed bindings avoids Debian python-clang packaging conflicts
      # that are common on GitHub runners. This approach is more reliable across different runner states.
      - name: Install libclang and python clang via pip
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev clang || true
          python3 -m pip install --upgrade pip
          python3 -m pip install clang

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            clang++ \
            lld \
            pkg-config \
            zstd \
            curl \
            ca-certificates \
            tar \
            perl \
            make \
            cmake \
            git \
            libffi-dev \
            libsqlite3-dev \
            libbz2-dev \
            liblzma-dev \
            libssl-dev \
            libcurl4-openssl-dev \
            libedit-dev \
            libncursesw5-dev \
            libgdbm-dev \
            libexpat1-dev \
            libtirpc-dev \
            xz-utils \
            ripgrep \
            ninja-build \
            jq
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Download and extract standalone Python
        run: |
          mkdir -p third_party/python-gnu
          echo "Downloading: ${PYTHON_URL}"
          curl -fL "${PYTHON_URL}" -o "${PYTHON_ARCHIVE}"
          mkdir -p "${PYTHON_GNU_DIR}"
          tar --zstd -xf "${PYTHON_ARCHIVE}" -C "${PYTHON_GNU_DIR}" --strip-components=1
          ls -al "${PYTHON_GNU_DIR}/install/lib" || true

      - name: Ensure target installed
        run: rustup target add ${TARGET_TRIPLE}

      - name: Build static binary via helper script
        env:
          PYTHON_EMBED_HOME_OVERRIDE: ${{ github.workspace }}/third_party/python-gnu/python/install
          PYTHON_BUILD_LIB_OVERRIDE: ${{ github.workspace }}/third_party/python-gnu/python/build/lib
          PYTHON_BIN_OVERRIDE: ${{ github.workspace }}/third_party/python-gnu/python/install/bin/python3.13
          PYTHON_INCLUDE_DIR_OVERRIDE: ${{ github.workspace }}/third_party/python-gnu/python/install/include
          PYTHON_LIB_DIR_OVERRIDE: ${{ github.workspace }}/third_party/python-gnu/python/install/lib
          PYO3_LIB_NAME: python3.13
          OPENSSL_DIR: ${{ github.workspace }}/third_party/python-gnu/python/install
          OPENSSL_LIB_DIR: ${{ github.workspace }}/third_party/python-gnu/python/build/lib
          OPENSSL_INCLUDE_DIR: ${{ github.workspace }}/third_party/python-gnu/python/install/include
          OPENSSL_STATIC: "1"
          LIBZ_SYS_STATIC: "1"
          LIBZ_STATIC: "1"
          ZLIB_STATIC: "1"
          BZIP2_STATIC: "1"
          LZMA_API_STATIC: "1"
          PKG_CONFIG_ALL_STATIC: "1"
        run: |
          chmod +x docker/build-static.sh
          docker/build-static.sh

      - name: Inspect binary
        run: |
          file dist/bedder-${TARGET_TRIPLE}-static
          ldd dist/bedder-${TARGET_TRIPLE}-static || true

      - name: Smoke test
        run: dist/bedder-${TARGET_TRIPLE}-static --help

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bedder-${{ matrix.target }}-static
          path: dist/bedder-${{ matrix.target }}-static
          if-no-files-found: error
