name: Build Static Binary with Embedded Python

on:
  push:
    branches: [ main, master, dev, build ]
  pull_request:
    branches: [ main, master, dev, build ]
  release:
    types: [ created ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-static-binary:
    name: Build Static Binary (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            python_url: https://github.com/astral-sh/uv/releases/download/0.8.4/cpython-3.13.9%2B20251014-x86_64_v2-unknown-linux-musl-lto%2Bstatic-full.tar.zst
          # Add other platforms as needed
          # - os: macos-13
          #   target: x86_64-apple-darwin
          # - os: macos-14
          #   target: aarch64-apple-darwin
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools clang libssl-dev openssl libffi-dev zstd curl

      - name: Download and extract static Python
        run: |
          # Create directories for Python
          mkdir -p third_party/python-musl
          
          # Download static Python from UV project releases
          echo "Downloading Python from: ${{ matrix.python_url }}"
          curl -L -o python-archive.tar.zst "${{ matrix.python_url }}"
          
          # Extract to the expected location
          mkdir -p third_party/python-musl/python
          tar --zstd -xf python-archive.tar.zst -C third_party/python-musl/python
          
          # Verify the extraction
          ls -la third_party/python-musl/python/install/lib/
          
          # Verify we have the static library
          if [ ! -f "third_party/python-musl/python/install/lib/libpython3.13.a" ]; then
            echo "Static Python library not found!"
            exit 1
          fi

      - name: Set up Python environment variables
        run: |
          echo "PYTHON_EMBED_HOME=${{ github.workspace }}/third_party/python-musl/python/install" >> $GITHUB_ENV
          echo "PYO3_LIB_DIR=${{ github.workspace }}/third_party/python-musl/python/install/lib" >> $GITHUB_ENV
          echo "PYO3_INCLUDE_DIR=${{ github.workspace }}/third_party/python-musl/python/install/include" >> $GITHUB_ENV

      - name: Set up musl target (Linux)
        if: runner.os == 'Linux' && contains(matrix.target, 'musl')
        run: |
          # Install musl target if needed
          rustup target add ${{ matrix.target }}

      - name: Build static binary
        run: |
          # Build with static linking and embedded Python
          cargo build --release --target ${{ matrix.target }} 
          
          # Verify the binary was created
          if [ ! -f "target/${{ matrix.target }}/release/bedder" ]; then
            echo "Binary not found!"
            exit 1
          fi

      - name: Check binary for static linking
        run: |
          # Check if the binary is truly static
          ldd "target/${{ matrix.target }}/release/bedder" 2>&1 | grep -q "not a dynamic executable" || echo "Binary may not be fully static"
          
          # Show file type
          file "target/${{ matrix.target }}/release/bedder"
          
          # Show file size
          ls -lah "target/${{ matrix.target }}/release/bedder"

      - name: Test binary
        run: |
          # Test that the binary works
          ./target/${{ matrix.target }}/release/bedder --help

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: bedder-static-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/bedder
          if-no-files-found: error

  create-release:
    name: Create Release
    needs: build-static-binary
    if: github.event_name == 'release'
    runs-on: ubuntu-22.04
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: releases

      - name: List downloaded artifacts
        run: |
          find releases -type f -name "bedder" | while read file; do
            echo "Found: $file"
            chmod +x "$file"
            file "$file"
          done

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            releases/*/*/bedder
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
