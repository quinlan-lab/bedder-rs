name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          libpython3-dev \
          libssl-dev \
          libexpat1-dev \
          zlib1g-dev \
          pkg-config
          
    - name: Install staticx
      run: |
        python3 -m pip install --user staticx
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Build release binary
      run: cargo build --release
      
    - name: Create static binary with staticx
      run: |
        staticx ./target/release/bedder ./bedder-static-linux-x86_64
        chmod +x ./bedder-static-linux-x86_64
        
    - name: Test static binary
      run: |
        ./bedder-static-linux-x86_64 --help || echo "Binary test failed"
        ldd ./bedder-static-linux-x86_64 || echo "Static binary verified (no dynamic dependencies)"
        ls -lh ./bedder-static-linux-x86_64
        
    - name: Create Release and Upload Asset
      uses: softprops/action-gh-release@v2
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Changes in ${{ github.ref_name }}
          
          ### Downloads
          - **bedder-static-linux-x86_64**: Static binary for Linux x86_64 (no dependencies required)
          
          ### Installation
          ```bash
          # Download and make executable
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/bedder-static-linux-x86_64
          chmod +x bedder-static-linux-x86_64
          
          # Optional: Move to PATH
          sudo mv bedder-static-linux-x86_64 /usr/local/bin/bedder
          ```
          
          ### Binary Info
          - **Size**: ~6MB
          - **Dependencies**: None (fully static)
          - **Python**: Works with any Python 3.8+ system
          - **Architecture**: x86_64 Linux
        files: |
          bedder-static-linux-x86_64
        draft: false
        prerelease: false 